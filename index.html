<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Security Audit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0284c7"/> 
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { background-color: #0284c7; color: white; }
        .tab-inactive { background-color: #e5e7eb; color: #374151; }
        .tab-inactive:hover { background-color: #d1d5db; }
        .content-scroll::-webkit-scrollbar { width: 8px; }
        .content-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .content-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .content-scroll::-webkit-scrollbar-thumb:hover { background: #555; }
        textarea { resize: vertical; }
        .action-item-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
        
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px; 
            height: 450px; 
            margin-left: auto;
            margin-right: auto;
        }
        @media (max-width: 768px) { /* md */
            .chart-container {
                height: 350px; 
            }
        }

        @media (min-width: 768px) { /* md */
            .action-item-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); align-items: end; }
            .action-item-grid .action-description { grid-column: span 3 / span 3; }
            .action-item-grid .action-notes { grid-column: span 6 / span 6; }
            .action-item-grid .action-remove-button-container { display: flex; align-items: flex-end; }
        }
         @media (max-width: 767px) { /* sm */
            .action-item-grid > div { margin-bottom: 0.5rem; }
        }

        @media print {
            .no-print { display: none !important; }
            main { margin: 0; padding: 20px; height: auto !important; overflow-y: visible !important; }
            body { font-size: 10pt; }
            .audit-section h2, .action-plan-section h2, .risk-visualization-section h2 { font-size: 18pt; margin-top: 20px; break-before: page; }
            .audit-item, .action-item-card, .risk-category-input { page-break-inside: avoid; }
            textarea, select, input[type="text"], input[type="date"], input[type="range"] { 
                border: 1px solid #ccc !important; 
                -webkit-appearance: none; -moz-appearance: none; appearance: none;
                background-color: #fff !important; 
                color: #000 !important;
            }
            select { padding-right: 1.5em !important; background-image: none !important; }
            .action-item-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important; }
            .chart-container { display: block !important; width: 90% !important; height: auto !important; margin: 20px auto; page-break-inside: avoid;} 
            canvas { max-width: 100%; height: auto !important; }
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">
    <div class="flex flex-col md:flex-row min-h-screen">
        <nav class="w-full md:w-72 bg-stone-200 p-4 space-y-2 md:sticky md:top-0 md:h-screen md:overflow-y-auto content-scroll no-print">
            <h1 class="text-2xl font-bold text-sky-700 mb-6">Security Audit</h1>
            <button data-section="introduction" class="nav-button w-full text-left p-3 rounded-md tab-active">1. Introduction</button>
            <button data-section="general_info" class="nav-button w-full text-left p-3 rounded-md tab-inactive">2. General Site Info</button>
            <button data-section="physical_security" class="nav-button w-full text-left p-3 rounded-md tab-inactive">3. Physical Security & Safety</button>
            <button data-section="personnel_performance" class="nav-button w-full text-left p-3 rounded-md tab-inactive">4. Personnel Performance</button>
            <button data-section="uniform_presentation" class="nav-button w-full text-left p-3 rounded-md tab-inactive">5. Uniform & Presentation</button>
            <button data-section="security_understanding" class="nav-button w-full text-left p-3 rounded-md tab-inactive">6. Security Understanding</button>
            <button data-section="corporate_specific" class="nav-button w-full text-left p-3 rounded-md tab-inactive">7. Corporate Site Specifics</button>
            <button data-section="factory_specific" class="nav-button w-full text-left p-3 rounded-md tab-inactive">8. Factory Site Specifics</button>
            <button data-section="inclusivity_review" class="nav-button w-full text-left p-3 rounded-md tab-inactive">9. Inclusivity Review</button>
            <button data-section="summary_recommendations" class="nav-button w-full text-left p-3 rounded-md tab-inactive">10. Summary & Recs</button>
            <button data-section="action_plan" class="nav-button w-full text-left p-3 rounded-md tab-inactive">11. Post-Audit Action Plan</button>
            <button data-section="risk_visualization" class="nav-button w-full text-left p-3 rounded-md tab-inactive">12. Overall Physical Security Risk Visual</button>
            
            <div class="mt-8 p-3 bg-white rounded-md shadow">
                <h3 class="text-lg font-semibold text-sky-700 mb-2">Audit Progress</h3>
                <p class="text-sm">Total Checklist Items: <span id="totalItemsCount">0</span></p>
                <p class="text-sm">Items Addressed: <span id="completedItemsCount">0</span></p>
                <hr class="my-2">
                <p class="text-sm">Compliant (C): <span id="compliantCount">0</span></p>
                <p class="text-sm">Partially Compliant (PC): <span id="partiallyCompliantCount">0</span></p>
                <p class="text-sm">Non-Compliant (NC): <span id="nonCompliantCount">0</span></p>
                <p class="text-sm">N/A: <span id="naCount">0</span></p>
                <p class="text-sm">Observation (Obs): <span id="observationCount">0</span></p>
            </div>

            <div class="mt-6 p-3 bg-white rounded-md shadow space-y-3">
                 <h3 class="text-lg font-semibold text-sky-700 mb-2">Actions</h3>
                 <button id="savePdfButton" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-md text-sm">
                    üìÑ Save as PDF (Print)
                 </button>
                 <button id="clearDataButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md text-sm mt-2">
                    üóëÔ∏è Clear All Data & Start New
                 </button>
            </div>
        </nav>

        <main class="flex-1 p-6 md:p-10 bg-white content-scroll md:h-screen md:overflow-y-auto">
            <section id="introduction" class="audit-section space-y-4">
                <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">1. Introduction</h2>
                <p class="text-sm text-gray-600 italic">This section provides an overview of the annual security audit's purpose, scope, and general guidelines for auditors. It sets the context for the entire audit process. Audit data is saved locally in your browser.</p>
                <div><h3 class="text-xl font-semibold text-stone-700">1.1 Purpose</h3><p>This annual audit aims to provide a comprehensive assessment of security provisions, safety measures, personnel performance, adherence to uniform standards, and overall security understanding across all [Your Company Name] factory and corporate sites in the UK. The audit is designed to identify strengths, weaknesses, and areas for improvement, ensuring a safe, secure, and productive environment for all employees, visitors, and contractors, with a strong emphasis on inclusivity and accessibility.</p></div>
                <div><h3 class="text-xl font-semibold text-stone-700">1.2 Scope</h3><p>This audit covers all aspects of physical security, personnel security, information security (where applicable), health and safety relevant to security operations, and the preparedness and understanding of security protocols by all relevant staff. It applies to:</p><ul class="list-disc list-inside ml-4"><li>All corporate office locations in the UK.</li><li>All factory and manufacturing sites in the UK.</li></ul></div>
                <div><h3 class="text-xl font-semibold text-stone-700">1.3 Frequency</h3><p>This audit is to be conducted annually. Interim audits may be conducted if significant changes to operations occur or specific concerns arise.</p></div>
                <div><h3 class="text-xl font-semibold text-stone-700">1.4 Auditor Guidance Notes</h3><ul class="list-disc list-inside ml-4 space-y-1"><li><strong>Inclusivity:</strong> Throughout this audit, consider how security measures, policies, and procedures impact individuals with diverse backgrounds, abilities, and needs. This includes physical accessibility, communication methods, cultural considerations, and neurodiversity.</li><li><strong>Evidence-Based:</strong> Observations should be supported by evidence (e.g., photographic, documentary, interviews).</li><li><strong>Collaboration:</strong> Engage with site managers, security personnel, Health & Safety representatives, and a diverse range of employees during the audit process.</li><li><strong>Confidentiality:</strong> Treat all information gathered with appropriate confidentiality.</li><li><strong>Rating Key (Suggested):</strong><ul class="list-disc list-inside ml-6"><li><strong>C (Compliant):</strong> Meets requirements.</li><li><strong>PC (Partially Compliant):</strong> Some aspects meet requirements, but improvements needed.</li><li><strong>NC (Non-Compliant):</strong> Does not meet requirements.</li><li><strong>N/A (Not Applicable):</strong> The item is not relevant to this specific site/area.</li><li><strong>Obs (Observation):</strong> A noteworthy point that isn't a compliance issue but could be an improvement or best practice.</li></ul></li></ul></div>
            </section>

            <section id="general_info" class="audit-section hidden space-y-4">
                <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">2. General Site Information</h2>
                <p class="text-sm text-gray-600 italic">Enter the basic details about the site being audited and the audit itself. This information is crucial for record-keeping and context.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="gi_date_audit" class="block text-sm font-medium text-stone-700">2.1 Date of Audit:</label><input type="date" id="gi_date_audit" data-section-key="general_info" data-item-key="2.1" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                    <div><label for="gi_site_name" class="block text-sm font-medium text-stone-700">2.2 Site Name/Location:</label><input type="text" id="gi_site_name" data-section-key="general_info" data-item-key="2.2" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                    <div><label for="gi_site_type" class="block text-sm font-medium text-stone-700">2.3 Type of Site:</label><select id="gi_site_type" data-section-key="general_info" data-item-key="2.3" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"><option value="">Select type...</option><option value="Corporate Office">Corporate Office</option><option value="Factory">Factory</option><option value="Mixed Use">Mixed Use</option></select></div>
                    <div><label for="gi_auditors" class="block text-sm font-medium text-stone-700">2.4 Auditor(s):</label><input type="text" id="gi_auditors" data-section-key="general_info" data-item-key="2.4" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                    <div><label for="gi_site_manager" class="block text-sm font-medium text-stone-700">2.5 Site Manager:</label><input type="text" id="gi_site_manager" data-section-key="general_info" data-item-key="2.5" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                    <div><label for="gi_security_manager" class="block text-sm font-medium text-stone-700">2.6 Security Manager/Lead:</label><input type="text" id="gi_security_manager" data-section-key="general_info" data-item-key="2.6" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                    <div><label for="gi_departments_audited" class="block text-sm font-medium text-stone-700">2.7 Departments Audited:</label><input type="text" id="gi_departments_audited" data-section-key="general_info" data-item-key="2.7" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                    <div><label for="gi_previous_audit_date" class="block text-sm font-medium text-stone-700">2.8 Previous Audit Date:</label><input type="date" id="gi_previous_audit_date" data-section-key="general_info" data-item-key="2.8" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></div>
                    <div class="md:col-span-2"><label for="gi_previous_audit_status" class="block text-sm font-medium text-stone-700">2.9 Status of Previous Audit Actions:</label><textarea id="gi_previous_audit_status" data-section-key="general_info" data-item-key="2.9" rows="3" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></textarea></div>
                </div>
            </section>

            <section id="physical_security" class="audit-section hidden space-y-4">
                 <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">3. Section A: Physical Security & Safety</h2>
                 <p class="text-sm text-gray-600 italic">This section focuses on the physical measures in place to protect the site, assets, and personnel, as well as general safety considerations related to physical security, including Risk Assessments and Method Statements (RAMS). Assess each item based on its effectiveness and compliance. Ratings for items in this section will populate the Overall Physical Security Risk Visual chart.</p>
                 <div id="physical_security_items_container" class="space-y-6"></div>
            </section>
            <section id="personnel_performance" class="audit-section hidden space-y-4">
                <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">4. Section B: Security Personnel Performance</h2>
                <p class="text-sm text-gray-600 italic">Evaluate the performance of security personnel based on their adherence to procedures, operational effectiveness, and professionalism. This often involves observation, interviews, and record checks.</p>
                <div id="personnel_performance_items_container" class="space-y-6"></div>
            </section>
            <section id="uniform_presentation" class="audit-section hidden space-y-4">
                 <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">5. Section C: Uniform & Presentation (Security Personnel)</h2>
                 <p class="text-sm text-gray-600 italic">This section assesses the adherence to uniform standards and the overall presentation of security personnel. Professional appearance contributes to authority and public confidence.</p>
                 <div id="uniform_presentation_items_container" class="space-y-6"></div>
            </section>
            <section id="security_understanding" class="audit-section hidden space-y-4">
                 <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">6. Section D: Security Understanding & Awareness (All Staff)</h2>
                 <p class="text-sm text-gray-600 italic">Gauge the general level of security awareness and understanding among all staff members (not just security personnel). This is crucial for a robust overall security culture.</p>
                 <div id="security_understanding_items_container" class="space-y-6"></div>
            </section>
            <section id="corporate_specific" class="audit-section hidden space-y-4">
                 <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">7. Section E: Corporate Site-Specific Considerations</h2>
                 <p class="text-sm text-gray-600 italic">Address security aspects particularly relevant to corporate office environments, such as data security, information handling, and IT asset protection. Mark N/A if the site is purely industrial without a significant office component.</p>
                 <div id="corporate_specific_items_container" class="space-y-6"></div>
            </section>
            <section id="factory_specific" class="audit-section hidden space-y-4">
                 <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">8. Section F: Factory Site-Specific Considerations</h2>
                 <p class="text-sm text-gray-600 italic">This section covers security and safety considerations unique to factory or manufacturing environments, including machinery safety, hazardous materials, and protection of goods. Mark N/A if the site is purely corporate.</p>
                 <div id="factory_specific_items_container" class="space-y-6"></div>
            </section>
            <section id="inclusivity_review" class="audit-section hidden space-y-4">
                 <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">9. Section G: Inclusivity & Accessibility Review (Overall)</h2>
                 <p class="text-sm text-gray-600 italic">This critical section reviews how security measures and the overall environment cater to inclusivity and accessibility for all individuals, including those with diverse needs and disabilities.</p>
                 <div id="inclusivity_review_items_container" class="space-y-6"></div>
            </section>

            <section id="summary_recommendations" class="audit-section hidden space-y-4">
                <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">10. Summary & Recommendations</h2>
                <p class="text-sm text-gray-600 italic">Conclude the audit by summarizing the overall assessment, key findings, and providing actionable recommendations. This section is vital for driving improvements.</p>
                <div class="space-y-4">
                    <div><label for="sr_overall_assessment" class="block text-sm font-medium text-stone-700">10.1 Overall Assessment:</label><textarea id="sr_overall_assessment" data-section-key="summary_recommendations" data-item-key="10.1" rows="4" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></textarea></div>
                    <div><label for="sr_key_strengths" class="block text-sm font-medium text-stone-700">10.2 Key Strengths:</label><textarea id="sr_key_strengths" data-section-key="summary_recommendations" data-item-key="10.2" rows="4" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></textarea></div>
                    <div><label for="sr_key_improvements" class="block text-sm font-medium text-stone-700">10.3 Key Areas for Improvement (with Priority High/Medium/Low):</label><textarea id="sr_key_improvements" data-section-key="summary_recommendations" data-item-key="10.3" rows="6" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" placeholder="Example:&#10;High: Perimeter fence breach at North boundary.&#10;Medium: Visitor logbook often incomplete.&#10;Low: Update CCTV signage with clearer ICO contact."></textarea></div>
                    <div><label for="sr_general_recommendations" class="block text-sm font-medium text-stone-700">10.4 General Recommendations:</label><textarea id="sr_general_recommendations" data-section-key="summary_recommendations" data-item-key="10.4" rows="4" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"></textarea></div>
                    <div><label for="sr_action_plan_required" class="block text-sm font-medium text-stone-700">10.5 Action Plan Required:</label><textarea id="sr_action_plan_required" data-section-key="summary_recommendations" data-item-key="10.5" rows="4" class="mt-1 audit-input block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" placeholder="Detail specific actions, responsible persons, and target dates. This may be a separate linked document."></textarea></div>
                </div>
            </section>

            <section id="action_plan" class="audit-section action-plan-section hidden space-y-6">
                <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">11. Post-Audit Action Plan</h2>
                <p class="text-sm text-gray-600 italic">Use this section to document and track specific actions arising from the audit. Click "Add New Action Item" to create entries.</p>
                <button id="addNewActionItemButton" class="mb-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md text-sm no-print">
                    Ôºã Add New Action Item
                </button>
                <div id="actionItemsContainer" class="space-y-6">
                    </div>
            </section>

            <section id="risk_visualization" class="audit-section risk-visualization-section hidden space-y-6">
                <h2 class="text-3xl font-semibold text-sky-700 border-b-2 border-sky-200 pb-2">12. Overall Physical Security Risk Visual</h2>
                <p class="text-sm text-gray-600 italic">This chart visualizes an aggregated risk score for key physical security categories, derived from your ratings in Section 3 ("Physical Security & Safety"). Higher scores indicate higher risk/lower compliance. The chart updates automatically as you rate items in Section 3.</p>
                
                <div class="chart-container bg-stone-50 p-4 rounded-lg shadow">
                    <canvas id="riskSpiderChart"></canvas>
                </div>
                 <div class="mt-6 p-4 border border-stone-200 rounded-lg shadow-sm bg-stone-50">
                    <h4 class="text-md font-semibold text-stone-700 mb-2">Chart Key (Aggregated Scores):</h4>
                    <ul class="list-disc list-inside text-sm space-y-1">
                        <li>Score 5: Predominantly Non-Compliant (NC) items in category</li>
                        <li>Score 4: Mix leaning towards Partially Compliant (PC) / NC items</li>
                        <li>Score 3: Mix with Observations (Obs) or some PCs</li>
                        <li>Score 1-2: Predominantly Compliant (C) / N/A items</li>
                    </ul>
                </div>
            </section>
        </main>
    </div>

<script>
    const LOCAL_STORAGE_KEY = 'interactiveAuditData';

    const riskVisualizationCategories = [
        { id: "A1.0", label: "Perimeter Security" },
        { id: "A2.0", label: "Access Control" },
        { id: "A3.0", label: "CCTV & Surveillance" },
        { id: "A4.0", label: "Alarm Systems" },
        { id: "A5.0", label: "Lighting" },
        { id: "A6.0", label: "Emergency Preparedness" },
        { id: "A7.0", label: "Hazard ID & RAMS" } 
    ];
    let riskSpiderChartInstance = null;

    const auditStructure = {
        physical_security: [
            { categoryId: "A1.0", category: "A1.0 Perimeter Security", items: [ { ref: "A1.1", text: "Fencing/Walls: Adequate height, good condition, no breaches?" }, { ref: "A1.2", text: "Gates: Secure, controlled access, good condition?" }, { ref: "A1.3", text: "Signage: Clear 'Private Property,' 'CCTV in Operation,' warning signs?" }, { ref: "A1.4", text: "Landscaping: Does it prevent hiding spots, allow clear lines of sight?" }, { ref: "A1.5", text: "Hostile Vehicle Mitigation (if applicable, e.g., bollards): In place, maintained?" } ]},
            { categoryId: "A2.0", category: "A2.0 Access Control", items: [ { ref: "A2.1", text: "Main Entrances: Controlled, staffed/electronic, appropriate for site?" }, { ref: "A2.2", text: "Staff Access: ID cards/fobs issued, managed, audited? Deactivation process for leavers?" }, { ref: "A2.3", text: "Visitor Management: Sign-in/out, ID verification, badges, escort policy? Are procedures clear and easy for all visitors to understand?" }, { ref: "A2.4", text: "Contractor Management: As per visitor, plus permits to work, RAMS reviewed?" }, { ref: "A2.5", text: "Deliveries: Secure area, manifest checks, driver ID?" }, { ref: "A2.6", text: "Key/Access Card Management: Secure storage, logs, audit trail, lost key procedure?" }, { ref: "A2.7", text: "Doors & Windows: Secure locks, good condition, alarmed if necessary?" }, { ref: "A2.8", text: "Accessibility: Are access control systems (readers, intercoms, doors) usable by people with disabilities (e.g., height, ease of use)?" } ]},
            { categoryId: "A3.0", category: "A3.0 CCTV & Surveillance", items: [ { ref: "A3.1", text: "Coverage: Adequate coverage of critical areas, entrances, perimeter? No blind spots?" }, { ref: "A3.2", text: "Image Quality: Clear, identifiable images (day & night)?" }, { ref: "A3.3", text: "Recording: Sufficient storage, correct time/date stamp, secure data?" }, { ref: "A3.4", text: "Maintenance: Regular checks, cleaning, fault reporting?" }, { ref: "A3.5", text: "Signage: ICO compliant 'CCTV in Operation' signage visible?" }, { ref: "A3.6", text: "Control Room (if applicable): Secure, restricted access, ergonomic for operators?" }, { ref: "A3.7", text: "GDPR Compliance: Data handling, access requests, retention policies for CCTV footage?" } ]},
            { categoryId: "A4.0", category: "A4.0 Alarm Systems (Intruder, Panic)", items: [ { ref: "A4.1", text: "Coverage: Adequate protection for vulnerable areas?" }, { ref: "A4.2", text: "Functionality: Tested regularly, faults reported/rectified?" }, { ref: "A4.3", text: "Monitoring: Internal/external monitoring, response procedures clear?" }, { ref: "A4.4", text: "Panic Alarms: Strategically located, tested, staff know how to use? Accessible to all staff?" } ]},
            { categoryId: "A5.0", category: "A5.0 Lighting", items: [ { ref: "A5.1", text: "External Lighting: Adequate for perimeter, car parks, walkways?" }, { ref: "A5.2", text: "Internal Lighting: Sufficient in all areas, especially at night?" }, { ref: "A5.3", text: "Emergency Lighting: Functional, tested, covers escape routes?" } ]},
            { categoryId: "A6.0", category: "A6.0 Emergency Preparedness", items: [ { ref: "A6.1", text: "Evacuation Plan: Clearly displayed, understood by staff, regular drills?" }, { ref: "A6.2", text: "Assembly Points: Clearly marked, safe, accessible?" }, { ref: "A6.3", text: "Fire Safety: Extinguishers serviced, fire doors clear, alarms tested?" }, { ref: "A6.4", text: "First Aid: Adequate kits, trained first aiders, incident reporting? Kits accessible?" }, { ref: "A6.5", text: "Lockdown Procedure: In place, understood by staff, practiced?" }, { ref: "A6.6", text: "Communication: Methods for communicating during emergencies (PA system, radios, etc.)? Are these methods accessible to all (e.g., visual alerts for hearing impaired)?" }, { ref: "A6.7", text: "PEEPs (Personal Emergency Evacuation Plans): In place for individuals requiring assistance?" } ]},
            { categoryId: "A7.0", category: "A7.0 Hazard Identification & Risk Assessment (General)", items: [ 
                { ref: "A7.1", text: "Regular H&S risk assessments conducted and reviewed?" }, 
                { ref: "A7.2", text: "Slips, Trips, Falls: Walkways clear, good housekeeping, warning signs?" }, 
                { ref: "A7.3", text: "Lone Worker Policy: In place, lone workers identified, procedures followed (check-ins, panic devices)?" }, 
                { ref: "A7.4", text: "DSE (Display Screen Equipment): Assessments for corporate staff, appropriate equipment?" }, 
                { ref: "A7.5", text: "Manual Handling: Training, aids provided, assessments (esp. factory)?" }, 
                { ref: "A7.6", text: "Reporting Systems: Clear process for reporting hazards/near misses? Is it accessible and encouraged for all?" },
                { ref: "A7.7", text: "RAMS Availability: Are relevant Risk Assessments & Method Statements readily available for tasks requiring them?" },
                { ref: "A7.8", text: "RAMS Review Process: Is there a formal process for regular review and update of RAMS, especially after incidents or changes in procedure?" },
                { ref: "A7.9", text: "RAMS Communication: Are RAMS effectively communicated to and understood by personnel performing the tasks?" },
                { ref: "A7.10", text: "RAMS Compliance Monitoring: Is compliance with RAMS monitored and enforced?" }
            ]}
        ],
        personnel_performance: [ { categoryId: "B1.0", category: "B1.0 Personnel Performance Assessment", items: [ { ref: "B1.1", text: "Adherence to SOPs: Do personnel understand and follow site-specific Standard Operating Procedures?" }, { ref: "B1.2", text: "Patrolling: Are patrols conducted as scheduled, effectively, and variably (if required)?" }, { ref: "B1.3", text: "Monitoring: Effective monitoring of CCTV, alarms, access points?" }, { ref: "B1.4", text: "Incident Response: Timely and appropriate response to incidents?" }, { ref: "B1.5", text: "Reporting: Accurate, clear, and timely completion of incident reports and logs?" }, { ref: "B1.6", text: "Communication Skills: Clear and professional communication (radio, phone, face-to-face)?" }, { ref: "B1.7", text: "Customer Service: Polite, helpful, and approachable demeanor with staff and visitors?" }, { ref: "B1.8", text: "Vigilance & Proactiveness: Alertness to suspicious activity, proactive engagement?" }, { ref: "B1.9", text: "Conflict Resolution: Trained in de-escalation techniques? Evidence of effective use?" }, { ref: "B1.10", text: "Knowledge of Site: Familiarity with layout, key areas, emergency exits?" }, { ref: "B1.11", text: "Training Records: SIA licenses current (if applicable), site-specific training, refresher training up-to-date?" }, { ref: "B1.12", text: "Inclusivity Training: Have security personnel received training on diversity, disability awareness, and unconscious bias?" }, { ref: "B1.13", text: "Use of Technology: Proficient in using security systems (CCTV, access control, alarms)?" } ]} ],
        uniform_presentation: [ { categoryId: "C1.0", category: "C1.0 Uniform and Presentation Standards", items: [ { ref: "C1.1", text: "Full Uniform Worn: All required components present as per policy?" }, { ref: "C1.2", text: "Condition: Uniform clean, neat, and in good repair?" }, { ref: "C1.3", text: "Fit: Uniform fits correctly and professionally?" }, { ref: "C1.4", text: "ID Badges: Clearly visible, correct details, worn as per policy?" }, { ref: "C1.5", text: "PPE (Personal Protective Equipment): Worn correctly if required for duty (e.g., hi-vis, safety shoes)? Condition of PPE?" }, { ref: "C1.6", text: "Grooming: Adherence to company grooming policy (ensure policy is inclusive and non-discriminatory)?" }, { ref: "C1.7", text: "Inclusivity of Policy: Does the uniform policy reasonably accommodate religious attire (e.g., headscarves) or medical needs, while maintaining security and safety standards?" } ]} ],
        security_understanding: [ { categoryId: "D1.0", category: "D1.0 Staff Security Awareness", items: [ { ref: "D1.1", text: "Reporting Suspicious Activity: Do staff know what to look for and how/who to report to?" }, { ref: "D1.2", text: "Emergency Contacts: Awareness of key security/emergency contact numbers?" }, { ref: "D1.3", text: "Evacuation Procedures: General understanding of site evacuation routes and assembly points?" }, { ref: "D1.4", text: "Access Control Awareness: Understanding of not tailgating, challenging unescorted visitors (if policy)?" }, { ref: "D1.5", text: "Phishing/Social Engineering (esp. Corporate): Awareness of risks and reporting procedures?" }, { ref: "D1.6", text: "Data Security/Confidentiality (esp. Corporate): Understanding of basic principles (clear desk, locking screens)?" }, { ref: "D1.7", text: "Security Training: Record of induction and refresher training on security awareness for all staff?" }, { ref: "D1.8", text: "Accessibility of Training: Are security awareness materials and training provided in formats accessible to all employees (e.g., considering language, literacy, learning styles, disabilities)?" }, { ref: "D1.9", text: "Reporting Mechanisms: Are staff aware of confidential reporting channels for security concerns (e.g., whistleblowing)? Are these trusted and accessible?" } ]} ],
        corporate_specific: [ { categoryId: "E1.0", category: "E1.0 Corporate Site Security", items: [ { ref: "E1.1", text: "Data Security: Adherence to GDPR and company data protection policies?" }, { ref: "E1.2", text: "Clean Desk Policy: Implemented and followed?" }, { ref: "E1.3", text: "Secure Document Disposal: Shredders available and used, confidential waste bins secure?" }, { ref: "E1.4", text: "IT Security: Password policies, software updates, locking screens, awareness of malware?" }, { ref: "E1.5", text: "Physical Security of IT Assets: Server rooms secure, laptops locked away?" }, { ref: "E1.6", text: "Visitor Access to Sensitive Areas: Restricted and monitored?" } ]} ],
        factory_specific: [ { categoryId: "F1.0", category: "F1.0 Factory Site Security", items: [ { ref: "F1.1", text: "Machinery Safety & Guarding: Guards in place, interlocks functional, emergency stops accessible and tested?" }, { ref: "F1.2", text: "COSHH (Control of Substances Hazardous to Health): Secure storage, handling procedures, spill kits?" }, { ref: "F1.3", text: "Vehicle & Pedestrian Segregation: Clear markings, barriers, safe routes?" }, { ref: "F1.4", text: "Loading Bay Security: Access control, vehicle checks, sealing procedures?" }, { ref: "F1.5", text: "Tool & Equipment Security: Secure storage, check-out/in procedures?" }, { ref: "F1.6", text: "Raw Material & Finished Goods Security: Secure storage, inventory controls, measures against theft?" }, { ref: "F1.7", text: "Waste Management Security: Secure disposal of sensitive waste or valuable scrap?" } ]} ],
        inclusivity_review: [ { categoryId: "G1.0", category: "G1.0 Inclusivity and Accessibility Assessment", items: [ { ref: "G1.1", text: "Physical Environment: Are security offices, control rooms, and key security points physically accessible (ramps, door widths, counter heights)?" }, { ref: "G1.2", text: "Communication Aids: Are alternative communication methods available for individuals with hearing or speech impairments at key interaction points (e.g., reception, security gates)?" }, { ref: "G1.3", text: "Signage & Wayfinding: Is security-related signage clear, using universal symbols where possible, and positioned for visibility by wheelchair users?" }, { ref: "G1.4", text: "Emergency Information: Is emergency information available in multiple formats (e.g., large print, audio, easy-read)?" }, { ref: "G1.5", text: "Staff Training on Inclusivity: Evidence that ALL staff (not just security) receive training on interacting with diverse individuals, including those with visible and non-visible disabilities?" }, { ref: "G1.6", text: "Feedback Mechanisms: Are there inclusive and anonymous ways for all staff and visitors to provide feedback or raise concerns about security and safety measures?" }, { ref: "G1.7", text: "Policy Review: Have security policies been reviewed for potential discriminatory impact (direct or indirect)?" } ]} ]
    };

    let auditData = getDefaultAuditData(); // Use a function to get initial structure

    const ratingOptions = [ { value: "", text: "Select Rating..." }, { value: "C", text: "C (Compliant)" }, { value: "PC", text: "PC (Partially Compliant)" }, { value: "NC", text: "NC (Non-Compliant)" }, { value: "N/A", text: "N/A (Not Applicable)" }, { value: "Obs", text: "Obs (Observation)" } ];
    const ragStatusOptions = [ {value: "", text: "Select RAG..."}, {value: "RED", text: "üî¥ RED (Outstanding)"}, {value: "AMBER", text: "üü† AMBER (In Progress)"}, {value: "GREEN", text: "üü¢ GREEN (Complete)"}, {value: "CLOSED", text: "‚ö´Ô∏è CLOSED"} ];

    function getDefaultAuditData() {
        const defaultData = {
            general_info: {},
            physical_security: {},
            personnel_performance: {},
            uniform_presentation: {},
            security_understanding: {},
            corporate_specific: {},
            factory_specific: {},
            inclusivity_review: {},
            summary_recommendations: {},
            action_plan_items: [],
            risk_visualization_scores: {}
        };
        // Initialize checklist item structures
        Object.keys(auditStructure).forEach(sectionKey => {
            defaultData[sectionKey] = defaultData[sectionKey] || {};
            auditStructure[sectionKey].forEach(categoryGroup => {
                categoryGroup.items.forEach(item => {
                    defaultData[sectionKey][item.ref] = { rating: "", comments: "" };
                });
            });
        });
        // Initialize risk scores
        riskVisualizationCategories.forEach(cat => {
            defaultData.risk_visualization_scores[cat.id] = 1; // Default to low risk
        });
        return defaultData;
    }

    function saveDataToLocalStorage() {
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(auditData));
            console.log("Audit data saved to localStorage.");
        } catch (e) {
            console.error("Error saving data to localStorage:", e);
            // Potentially notify user if storage is full or not supported
        }
    }

    function loadDataFromLocalStorage() {
        const savedDataString = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (savedDataString) {
            try {
                const savedData = JSON.parse(savedDataString);
                // Deep merge or intelligently apply savedData to a default structure
                // to ensure all keys are present if the structure evolved.
                // For now, a direct assignment for simplicity if structure is stable.
                auditData = { ...getDefaultAuditData(), ...savedData }; 

                // Ensure nested objects like action_plan_items and risk_visualization_scores are also correctly merged/initialized
                auditData.action_plan_items = savedData.action_plan_items || [];
                auditData.risk_visualization_scores = savedData.risk_visualization_scores || getDefaultAuditData().risk_visualization_scores;
                
                // Ensure all checklist item structures exist
                Object.keys(auditStructure).forEach(sectionKey => {
                    auditData[sectionKey] = auditData[sectionKey] || getDefaultAuditData()[sectionKey];
                     auditStructure[sectionKey].forEach(categoryGroup => {
                        categoryGroup.items.forEach(item => {
                             auditData[sectionKey][item.ref] = savedData[sectionKey]?.[item.ref] || { rating: "", comments: "" };
                        });
                    });
                });


                console.log("Audit data loaded from localStorage.");
                return true;
            } catch (e) {
                console.error("Error parsing saved data from localStorage:", e);
                // If parsing fails, start with a fresh audit
                auditData = getDefaultAuditData();
                return false;
            }
        }
        auditData = getDefaultAuditData(); // Ensure auditData is initialized if nothing in localStorage
        return false;
    }

    function clearAllData() {
        if (confirm("Are you sure you want to clear all entered data and start a new audit? This cannot be undone.")) {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            auditData = getDefaultAuditData(); // Reset to default structure
            // Re-render all sections to reflect the cleared data
            renderAuditSections(); 
            renderActionItems();
            updateProgressOverview();
            updateOverallRiskSpiderChartDataAndRender();
            // Navigate to the first section or a default section
            document.querySelector('.nav-button[data-section="introduction"]').click();
            alert("All data has been cleared. You can start a new audit.");
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        loadDataFromLocalStorage(); // Load data first

        const navButtons = document.querySelectorAll('.nav-button');
        const sections = document.querySelectorAll('.audit-section');

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetSectionId = button.dataset.section;
                sections.forEach(section => section.classList.add('hidden'));
                const targetElement = document.getElementById(targetSectionId);
                if (targetElement) targetElement.classList.remove('hidden');
                
                navButtons.forEach(btn => {
                    btn.classList.remove('tab-active');
                    btn.classList.add('tab-inactive');
                });
                button.classList.add('tab-active');
                button.classList.remove('tab-inactive');

                if (targetSectionId === 'risk_visualization') {
                    updateOverallRiskSpiderChartDataAndRender(); 
                }
            });
        });

        renderAuditSections(); // Now render with potentially loaded data
        renderActionItems();   // Render action items with potentially loaded data
        initializeCountsAndChart(); // Calculates counts and updates chart based on loaded/default data
        
        document.querySelectorAll('.audit-input').forEach(input => {
            input.addEventListener('change', handleAuditInputChange);
            input.addEventListener('keyup', handleAuditInputChange);
        });
        
        const addNewActionButton = document.getElementById('addNewActionItemButton');
        if(addNewActionButton) addNewActionButton.addEventListener('click', addNewActionItem);
        
        document.getElementById('savePdfButton').addEventListener('click', () => window.print());
        document.getElementById('clearDataButton').addEventListener('click', clearAllData);

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    });
    
    function initializeCountsAndChart() {
        let totalItems = 0;
        Object.keys(auditStructure).forEach(sectionKey => {
            auditStructure[sectionKey].forEach(categoryGroup => {
                categoryGroup.items.forEach(() => totalItems++);
            });
        });
        document.getElementById('totalItemsCount').textContent = totalItems;
        
        updateProgressOverview(); // Calculate initial counts based on loaded data
        updateOverallRiskSpiderChartDataAndRender(); // Calculate initial chart scores
    }


    function getScoreFromRating(rating) {
        switch(rating) {
            case "NC": return 5; 
            case "PC": return 4; 
            case "Obs": return 3; 
            case "C": return 1;  
            case "N/A": return 1; 
            default: return 1;   
        }
    }

    function calculateAverageScoreForCategory(categoryId) {
        let totalScore = 0;
        let itemCount = 0;
        const categoryData = auditStructure.physical_security.find(catGroup => catGroup.categoryId === categoryId);

        if (categoryData && categoryData.items) {
            categoryData.items.forEach(item => {
                const ratingData = auditData.physical_security?.[item.ref];
                if (ratingData && ratingData.rating && ratingData.rating !== "") { 
                    totalScore += getScoreFromRating(ratingData.rating);
                    itemCount++;
                }
            });
        }
        return itemCount > 0 ? parseFloat((totalScore / itemCount).toFixed(2)) : 1; 
    }


    function renderAuditSections() {
        Object.keys(auditStructure).forEach(sectionKey => {
            const containerId = `${sectionKey}_items_container`;
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = ''; 

            auditStructure[sectionKey].forEach(categoryGroup => { 
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-6 p-4 border border-stone-200 rounded-lg shadow-sm';
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'text-xl font-semibold text-stone-700 mb-3';
                categoryTitle.textContent = categoryGroup.category; 
                categoryDiv.appendChild(categoryTitle);

                categoryGroup.items.forEach(item => { 
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'audit-item p-3 border-t border-stone-200';
                    if (categoryGroup.items.indexOf(item) === 0) itemDiv.classList.remove('border-t');
                    
                    const itemHeaderDiv = document.createElement('div');
                    itemHeaderDiv.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2';
                    const itemTextP = document.createElement('p');
                    itemTextP.className = 'text-stone-700 flex-1';
                    itemTextP.innerHTML = `<strong class="text-sky-600">${item.ref}:</strong> ${item.text}`;
                    itemHeaderDiv.appendChild(itemTextP);

                    const ratingSelect = document.createElement('select');
                    ratingSelect.className = 'audit-rating mt-2 sm:mt-0 sm:ml-4 p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500';
                    ratingSelect.dataset.sectionKey = sectionKey;
                    ratingSelect.dataset.itemKey = item.ref;
                    ratingSelect.dataset.categoryId = categoryGroup.categoryId; 
                    ratingOptions.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.text;
                        ratingSelect.appendChild(option);
                    });
                    // Set value from auditData
                    const ratingDataItem = auditData[sectionKey]?.[item.ref];
                    ratingSelect.value = ratingDataItem?.rating || "";
                    itemHeaderDiv.appendChild(ratingSelect);
                    itemDiv.appendChild(itemHeaderDiv);

                    const commentsTextarea = document.createElement('textarea');
                    commentsTextarea.rows = 2;
                    commentsTextarea.className = 'audit-comments w-full mt-1 p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500';
                    commentsTextarea.placeholder = "Comments / Evidence / Actions Required...";
                    commentsTextarea.dataset.sectionKey = sectionKey;
                    commentsTextarea.dataset.itemKey = item.ref;
                    commentsTextarea.dataset.categoryId = categoryGroup.categoryId; 
                     // Set value from auditData
                    commentsTextarea.value = ratingDataItem?.comments || "";
                    itemDiv.appendChild(commentsTextarea);
                    categoryDiv.appendChild(itemDiv);

                    ratingSelect.addEventListener('change', handleAuditInputChange);
                    commentsTextarea.addEventListener('keyup', handleAuditInputChange);
                    commentsTextarea.addEventListener('change', handleAuditInputChange);
                });
                container.appendChild(categoryDiv);
            });
        });
         // For general_info and summary_recommendations text inputs/textareas
        document.querySelectorAll('#general_info input, #general_info textarea, #summary_recommendations textarea').forEach(input => {
            const sectionKey = input.dataset.sectionKey;
            const itemKey = input.dataset.itemKey;
            if (auditData[sectionKey] && typeof auditData[sectionKey][itemKey] !== 'undefined') {
                input.value = auditData[sectionKey][itemKey];
            }
        });
    }

    function handleAuditInputChange(event) {
        const target = event.target;
        const sectionKey = target.dataset.sectionKey;
        const itemKey = target.dataset.itemKey;
        const categoryId = target.dataset.categoryId; 

        if (!auditData[sectionKey]) auditData[sectionKey] = {};
        
        if (target.classList.contains('audit-rating')) {
            if (!auditData[sectionKey][itemKey] || typeof auditData[sectionKey][itemKey] !== 'object') {
                 auditData[sectionKey][itemKey] = { rating: "", comments: "" };
            }
            auditData[sectionKey][itemKey].rating = target.value;
        } else if (target.classList.contains('audit-comments')) {
             if (!auditData[sectionKey][itemKey] || typeof auditData[sectionKey][itemKey] !== 'object') {
                 auditData[sectionKey][itemKey] = { rating: "", comments: "" };
            }
            auditData[sectionKey][itemKey].comments = target.value;
        } else { // For general_info and summary_recommendations
             auditData[sectionKey][itemKey] = target.value;
        }
        updateProgressOverview();
        saveDataToLocalStorage(); // Save after every input change

        if (sectionKey === 'physical_security' && categoryId) {
            updateOverallRiskSpiderChartDataAndRender();
        }
    }

    function updateProgressOverview() {
        let completed = 0;
        let c = 0, pc = 0, nc = 0, na = 0, obs = 0;
        // Total items already calculated in initializeCountsAndChart

        Object.keys(auditStructure).forEach(sectionKey => {
             auditStructure[sectionKey].forEach(categoryGroup => {
                categoryGroup.items.forEach(item => {
                    const itemData = auditData[sectionKey]?.[item.ref];
                    if (itemData && itemData.rating && itemData.rating !== "") {
                        completed++;
                        switch(itemData.rating) {
                            case "C": c++; break;
                            case "PC": pc++; break;
                            case "NC": nc++; break;
                            case "N/A": na++; break;
                            case "Obs": obs++; break;
                        }
                    }
                });
            });
        });
        
        const completedItemsEl = document.getElementById('completedItemsCount');
        if (completedItemsEl) completedItemsEl.textContent = completed;
        const compliantEl = document.getElementById('compliantCount');
        if (compliantEl) compliantEl.textContent = c;
        const partiallyCompliantEl = document.getElementById('partiallyCompliantCount');
        if (partiallyCompliantEl) partiallyCompliantEl.textContent = pc;
        const nonCompliantEl = document.getElementById('nonCompliantCount');
        if (nonCompliantEl) nonCompliantEl.textContent = nc;
        const naEl = document.getElementById('naCount');
        if (naEl) naEl.textContent = na;
        const obsEl = document.getElementById('observationCount');
        if (obsEl) obsEl.textContent = obs;
    }

    function addNewActionItem() {
        const newAction = {
            id: `action-${Date.now()}`,
            ref: "",
            action: "",
            owner: "",
            targetDate: "",
            rag: "",
            notes: ""
        };
        if (!auditData.action_plan_items) auditData.action_plan_items = []; // Ensure array exists
        auditData.action_plan_items.push(newAction);
        renderActionItems();
        saveDataToLocalStorage(); 
    }

    function renderActionItems() {
        const container = document.getElementById('actionItemsContainer');
        if (!container) return;
        container.innerHTML = ''; 

        if (!auditData.action_plan_items || auditData.action_plan_items.length === 0) {
            // Optionally display a message if no action items
            // container.innerHTML = '<p class="text-stone-500">No action items yet. Click "Add New Action Item" to begin.</p>';
            return;
        }

        auditData.action_plan_items.forEach((action, index) => {
            const card = document.createElement('div');
            card.className = 'action-item-card p-4 border border-stone-300 rounded-lg shadow bg-stone-50';
            
            const grid = document.createElement('div');
            grid.className = 'action-item-grid';

            grid.appendChild(createActionInputDiv('Ref:', 'text', action.ref, (e) => { action.ref = e.target.value; saveDataToLocalStorage(); }, 'action-ref'));
            grid.appendChild(createActionInputDiv('Action:', 'textarea', action.action, (e) => { action.action = e.target.value; saveDataToLocalStorage(); }, 'action-description', 2));
            grid.appendChild(createActionInputDiv('Owner:', 'text', action.owner, (e) => { action.owner = e.target.value; saveDataToLocalStorage(); }, 'action-owner'));
            grid.appendChild(createActionInputDiv('Target Date:', 'date', action.targetDate, (e) => { action.targetDate = e.target.value; saveDataToLocalStorage(); }, 'action-target-date'));
            
            const ragDiv = document.createElement('div');
            const ragLabel = document.createElement('label');
            ragLabel.className = 'block text-sm font-medium text-stone-700 mb-1';
            ragLabel.textContent = 'RAG:';
            ragDiv.appendChild(ragLabel);
            const ragSelect = document.createElement('select');
            ragSelect.className = 'w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500';
            ragStatusOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                ragSelect.appendChild(option);
            });
            ragSelect.value = action.rag;
            ragSelect.addEventListener('change', (e) => { action.rag = e.target.value; saveDataToLocalStorage(); });
            ragDiv.appendChild(ragSelect);
            grid.appendChild(ragDiv);

            grid.appendChild(createActionInputDiv('Notes/Updates:', 'textarea', action.notes, (e) => { action.notes = e.target.value; saveDataToLocalStorage(); }, 'action-notes', 3));

            const removeButtonDiv = document.createElement('div');
            removeButtonDiv.className = 'action-remove-button-container pt-2 md:pt-0'; 
            const removeButton = document.createElement('button');
            removeButton.textContent = 'üóëÔ∏è Remove';
            removeButton.className = 'bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-md text-xs';
            removeButton.onclick = () => {
                if (confirm("Are you sure you want to remove this action item?")) {
                    auditData.action_plan_items.splice(index, 1);
                    renderActionItems();
                    saveDataToLocalStorage();
                }
            };
            removeButtonDiv.appendChild(removeButton);
            grid.appendChild(removeButtonDiv);

            card.appendChild(grid);
            container.appendChild(card);
        });
    }

    function createActionInputDiv(labelText, inputType, value, eventListener, customClass = '', rows = 2) {
        const div = document.createElement('div');
        if (customClass) div.className = customClass;

        const label = document.createElement('label');
        label.className = 'block text-sm font-medium text-stone-700 mb-1';
        label.textContent = labelText;
        div.appendChild(label);

        let inputElement;
        if (inputType === 'textarea') {
            inputElement = document.createElement('textarea');
            inputElement.rows = rows;
        } else {
            inputElement = document.createElement('input');
            inputElement.type = inputType;
        }
        inputElement.className = 'w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500';
        inputElement.value = value || ""; // Ensure value is not undefined
        inputElement.addEventListener('change', eventListener);
        inputElement.addEventListener('keyup', eventListener);
        div.appendChild(inputElement);
        return div;
    }
    
    function updateOverallRiskSpiderChartDataAndRender() {
        riskVisualizationCategories.forEach(cat => {
            auditData.risk_visualization_scores[cat.id] = calculateAverageScoreForCategory(cat.id);
        });
        saveDataToLocalStorage(); // Save updated risk scores

        const riskSection = document.getElementById('risk_visualization');
        // Only render if section is visible or chart instance already exists to avoid errors
        if ((riskSection && !riskSection.classList.contains('hidden')) || riskSpiderChartInstance) {
            renderOverallRiskSpiderChart();
        }
    }
    
    function renderOverallRiskSpiderChart() {
        const ctx = document.getElementById('riskSpiderChart')?.getContext('2d');
        if (!ctx) {
            console.log("Risk spider chart canvas not found, skipping render.");
            return;
        }

        const labels = riskVisualizationCategories.map(cat => cat.label);
        const data = riskVisualizationCategories.map(cat => auditData.risk_visualization_scores[cat.id] || 1); // Default to 1 if score undefined

        if (riskSpiderChartInstance) {
            riskSpiderChartInstance.destroy();
        }

        riskSpiderChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Aggregated Risk Score (Higher = Higher Risk)',
                    data: data,
                    fill: true,
                    backgroundColor: 'rgba(2, 132, 199, 0.2)', 
                    borderColor: 'rgb(2, 132, 199)', 
                    pointBackgroundColor: 'rgb(2, 132, 199)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(2, 132, 199)'
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                elements: {
                    line: {
                        borderWidth: 2
                    }
                },
                scales: {
                    r: {
                        angleLines: { display: true },
                        suggestedMin: 0,
                        suggestedMax: 5, 
                        pointLabels: {
                            font: { size: 10 }, 
                            callback: function(value, index, values) {
                                const words = value.split(' ');
                                let line = '';
                                const lines = [];
                                const maxCharsPerLine = 12; 
                                for (let i = 0; i < words.length; i++) {
                                    if ((line + words[i]).length > maxCharsPerLine && line.length > 0) {
                                        lines.push(line);
                                        line = '';
                                    }
                                    line += (line.length > 0 ? ' ' : '') + words[i];
                                }
                                lines.push(line);
                                return lines;
                            }
                        },
                        ticks: {
                            stepSize: 1,
                            backdropColor: 'rgba(255, 255, 255, 0.75)' 
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.r !== null) {
                                    label += parseFloat(context.parsed.r).toFixed(2); 
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
</body>
</html>
```

---

**Step 2: Create `manifest.json`**

You need to create a file named `manifest.json` **in the same directory** as your `interactive_security_audit_spa_v5_pwa_localstorage.html` file.

Copy and paste the following content into your `manifest.json` file:

```json
{
  "name": "Interactive Security Audit",
  "short_name": "SecurityAudit",
  "description": "An interactive application for conducting security audits.",
  "start_url": "./interactive_security_audit_spa_v5_pwa_localstorage.html",
  "display": "standalone",
  "background_color": "#f8fafc",
  "theme_color": "#0284c7",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "images/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "images/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
```

* **Note on Icons:**
    * The manifest refers to `images/icon-192x192.png` and `images/icon-512x512.png`. You will need to create these icon images yourself.
    * Create a folder named `images` in the same directory as your HTML and `manifest.json` files.
    * Place your 192x192 pixel PNG icon and your 512x512 pixel PNG icon in that `images` folder. You can find many free icon generator tools online.

---

**Step 3: Create `service-worker.js`**

You need to create another file named `service-worker.js` **in the same directory** as your HTML and `manifest.json` files. This provides very basic offline caching for the app shell.

Copy and paste the following content into your `service-worker.js` file:

```javascript
const CACHE_NAME = 'security-audit-cache-v1';
const urlsToCache = [
  './', // Caches the root (if your HTML is named index.html and at root)
  './interactive_security_audit_spa_v5_pwa_localstorage.html', // Main HTML file
  // Add other essential assets here if they were separate (e.g., CSS, specific JS files)
  // For CDN assets like Tailwind and Chart.js, the browser handles caching;
  // service workers can cache them too but it's more complex for cross-origin resources.
  // For simplicity, we're focusing on caching the local app shell.
];

self.addEventListener('install', event => {
  // Perform install steps
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => {
        console.log('Opened cache');
        return cache.addAll(urlsToCache);
      })
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        // Cache hit - return response
        if (response) {
          return response;
        }
        return fetch(event.request); // Or provide a fallback offline page
      }
    )
  );
});

self.addEventListener('activate', event => {
  const cacheWhitelist = [CACHE_NAME];
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheWhitelist.indexOf(cacheName) === -1) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
```

---

**Summary of Changes in the HTML (`interactive_security_audit_spa_v5_pwa_localstorage.html`):**

1.  **Link to Manifest:** Added `<link rel="manifest" href="manifest.json">` in the `<head>`.
2.  **Theme Color Meta Tag:** Added `<meta name="theme-color" content="#0284c7"/>` for PWA address bar styling.
3.  **Local Storage Implementation:**
    * `LOCAL_STORAGE_KEY` constant defined.
    * `getDefaultAuditData()`: Helper function to create a clean initial data structure.
    * `saveDataToLocalStorage()`: Saves the current `auditData` object to `localStorage`.
    * `loadDataFromLocalStorage()`: Loads data from `localStorage` when the app starts. If no data is found or there's an error, it initializes with default data. Includes improved merging logic.
    * Called `saveDataToLocalStorage()` after every significant data change (input changes, adding/removing action items, updating risk scores).
    * Called `loadDataFromLocalStorage()` at the beginning of the `DOMContentLoaded` listener.
    * `initializeCountsAndChart()` function created to correctly calculate total items and update UI elements after data is loaded/initialized.
    * `renderAuditSections()`, `renderActionItems()`, etc., now populate fields from the `auditData` which might have been loaded from `localStorage`.
4.  **"Clear All Data" Button:** Added a new button in the sidebar to clear all data from `localStorage` and reset the form, allowing the user to start a completely fresh audit.
5.  **Service Worker Registration:** Added JavaScript at the end of the `DOMContentLoaded` listener to register `service-worker.js`.
6.  **Removed JSON Download:** The "Download Audit Data (JSON)" button and its associated function `downloadAuditDataAsJson()` have been removed.

**How to Use This:**

1.  Save the main HTML content above as `interactive_security_audit_spa_v5_pwa_localstorage.html`.
2.  Create `manifest.json` with the content provided, in the same folder.
3.  Create `service-worker.js` with the content provided, in the same folder.
4.  Create an `images` subfolder and add your `icon-192x192.png` and `icon-512x512.png` files into it.
5.  **Serve these files using a local web server** (e.g., VS Code Live Server, Python's `http.server`, Node.js `http-server`). You generally cannot test PWA features by just opening the HTML file directly from your file system (`file:///...`).
6.  Open the local web server address in Chrome (or another supporting browser) on your desktop or Android phone.
7.  On Android, you should see a prompt or an option in the browser menu to "Add to Home Screen."

Now, when you use the app, your data should be saved on your device. If you close and reopen it (from the home screen icon if installed), your previously entered data should still be there. The "Clear All Data" button will let you start fre
